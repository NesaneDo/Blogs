#  Android  自定义 View [Loading View] ### 自定义一个 `正在加载` 的动画，准备做成一个系列，旨在记录在自定义 View 的过程中的一些心得和探索 Android 自定义 View 的奥妙，*本篇文章主要通过这个例子介绍一下自定义 view 的大体过程*#### 效果图#### 步骤##### 1. 确定自定义 View 有哪些自定义属性  将其写在 `attrs.xml` 中 ( 如果没有就在 `res` ->` values` 文件夹下新建 `Values resource file` ），就像这样   ```<?xml version="1.0" encoding="utf-8"?><resources>    <!--简单加载动画：简单旋转-->    <declare-styleable name="LoadingViewSimple1">        <!--圆环颜色-->        <attr name="colorBgCircle" format="color"/>        <!--旋转部分颜色-->        <attr name="colorArc" format="color"/>        <!--字体颜色-->        <attr name="colorTextLoading" format="color"/>    </declare-styleable></resources>```    其中用 `<declare-styleable>` 包含的部分代表一个自定义 View 的值可变属性，就是可以通过修改它们的值然后让你自定义的 View 呈现不同的样子。用 `<attr>` 包含的部分代表具体的各个属性  ##### 2. 新建 java 文件并继承 View 类或已有的 View 的子类，重写三个构造方法  ```	public LoadingViewSimple1(Context context) {    this(context, null);}public LoadingViewSimple1(Context context, @Nullable AttributeSet attrs) {    this(context, attrs, 0);}public LoadingViewSimple1(Context context, @Nullable AttributeSet attrs, int defStyleAttr) {    super(context, attrs, defStyleAttr);    TypedArray typedArray=context.obtainStyledAttributes(attrs, R.styleable.LoadingViewSimple1,defStyleAttr,0);    colorCircle=typedArray.getColor(R.styleable.LoadingViewSimple1_colorBgCircle,Color.LTGRAY);    colorArc=typedArray.getColor(R.styleable.LoadingViewSimple1_colorArc,Color.BLACK);    colorTextLoading=typedArray.getColor(R.styleable.LoadingViewSimple1_colorTextLoading,Color.DKGRAY);    init();    typedArray.recycle();//回收}  ```这里一般将三个构造方法连接起来，这样无论调用哪个最终都会到第三个构造方法里去  然后在第三个构造方法里用 `TypedArray` 加载刚才自定义的属性，有些类型的属性需要有默认值，如 Color   一些初始化工作可以放到这里来做**注意：** 加载完后别忘了回收资源: `typedArray.recycle();` ##### 3.  重写 `onMeasure()` 方法（可选）简单来讲， `onMeasure()` 方法就是计算自定义 view 的大小的，即宽高。但是这个方法有更深奥的知识，这里只做简单的介绍  如果想要深入了解 `onMeasure()` 方法，你可以查看 [这里](https://www.nesanero.com)  ```@Overrideprotected void onMeasure(int widthMeasureSpec, int heightMeasureSpec) {    super.onMeasure(widthMeasureSpec, heightMeasureSpec);    int widthSize = MeasureSpec.getSize(widthMeasureSpec);    int widthMode = MeasureSpec.getMode(widthMeasureSpec);    int heightSize = MeasureSpec.getSize(heightMeasureSpec);    int heightMode = MeasureSpec.getMode(heightMeasureSpec);    //指定了宽度    if (widthMode == MeasureSpec.EXACTLY) {        width = widthSize;    //未指定宽度，一般是 wrap_content 的情况    }else if(widthMode==MeasureSpec.AT_MOST){        width=200;    }    //指定了高度    if (heightMode == MeasureSpec.EXACTLY) {        height = heightSize;    //同宽度，一般是 wrap_content 的情况    }else if (heightMode==MeasureSpec.AT_MOST){        height=200;    }    //直径为边长较短的一个    d = Math.min(width, height);    //圆环的宽度由直径决定    widthStroke = (int) (d * 0.04 + 1);    //保存结果，不调用此方法宽高无效，由父视图决定此视图的大小    setMeasuredDimension(width,height);}```这里为了简单，将 `wrap_content` 的情况简化了，设置了一个固定大小，所以呈现出的就是 ***图2*** 的样子##### 4.  重写 `onDraw()` 方法这应该是自定义 View 过程中最重要的部分之一，在这里，你任何天马行空的想法都可以实现，不过有可能会涉及到 `数学和物理` 的一些知识。同样，这里只是简单的展示一下基本的用法，正如开头说的那样，这篇文章主要是想介绍自定义 view 的大体流程。如果想要了解更多关于 `onDraw()` 的知识，你可以点击 [这里](https://www.nesanero.com)  好的，来看看今天这个简单的加载动画是如何实现的吧  ```@Overrideprotected void onDraw(Canvas canvas) {    super.onDraw(canvas);    //设置画笔颜色    paintText.setColor(colorTextLoading);    paintBgCircle.setColor(colorCircle);    paintArc.setColor(colorArc);    //设置圆环宽度    paintArc.setStrokeWidth(widthStroke);    paintBgCircle.setStrokeWidth(widthStroke);    float w = widthStroke / 2;    //画背景圆    canvas.drawCircle(d / 2, d / 2, d / 2 - w, paintBgCircle);    //画两个弧形    rectF.set(w, w, d - w, d - w);    canvas.drawArc(rectF, startAngle, 45, false, paintArc);    canvas.drawArc(rectF, startAngle + 180, 45, false, paintArc);    //画文字    String text = "Loading";    //计算文字位置    paintText.setTextSize(d / 5);    paintText.getTextBounds(text, 0, text.length(), rect);    canvas.drawText(text, d / 2 - (float) rect.width() / 2, d / 2 + paintText.descent(), paintText);}```简述一下画 view 的思路：   - 步骤 1. 从里到外，从大到小将 view 拆分，想象将它们分别画在一张纸- 步骤 2. 按 `步骤1` 的层级关系开始画- 步骤 3. 按 `步骤1` 的层级关系组合（叠）起来  ##### 5. 添加动画（可选）```/** * 动画 * * @param duration 动画持续时间 */public void startAnimation(int duration) {    //旋转一圈    animator = ValueAnimator.ofFloat(startAngle, startAngle + 360);    animator.addUpdateListener(new ValueAnimator.AnimatorUpdateListener() {        @Override        public void onAnimationUpdate(ValueAnimator valueAnimator) {            setStartAngle((Float) valueAnimator.getAnimatedValue());        }    });    //动画时长    animator.setDuration(duration);    //无限次重复    animator.setRepeatCount(ValueAnimator.INFINITE);    animator.start();    isRunning=true;}```##### 6. setter 和 getter（可选）getter 和 setter 方法比较简单，就不过多赘述。有一点需要提的是：给自定义 view 重新设置属性后要调用 `invalidate()` 来更新 view 。##### 使用方法##### 1. 在 `布局文件 layout ` 中引用 ```<com.android.loadingview1.LoadingViewSimple1    android:id="@+id/loading_view"    android:layout_width="160dp"    android:layout_height="160dp"    android:layout_marginStart="8dp"    android:layout_marginTop="8dp"    android:layout_marginEnd="8dp"    android:layout_marginBottom="8dp"    app:layout_constraintBottom_toBottomOf="parent"    app:layout_constraintEnd_toEndOf="parent"    app:layout_constraintStart_toStartOf="parent"    app:layout_constraintTop_toTopOf="parent" />```自定义的 View 要加上完整的包名，如果要添加自定义的属性，则需要加上命名空间，但如果是使用 **`Android Studio`** 编写的话，一般会自动给加上，如>` xmlns:app="http://schemas.android.com/apk/res-auto"`  其中 app 可以换成自己喜欢的名字  ##### 2. 在使用的地方对自定义进行操作  ```public class MainActivity extends AppCompatActivity {    @Override    protected void onCreate(Bundle savedInstanceState) {        super.onCreate(savedInstanceState);        setContentView(R.layout.activity_main);        final LoadingViewSimple1 loadingViewSimple1=findViewById(R.id.loading_view);        //初始动画        loadingViewSimple1.startAnimation(800);        //设置点击监听        loadingViewSimple1.setOnClickListener(new View.OnClickListener() {            @Override            public void onClick(View v) {                if (loadingViewSimple1.isRunning()){//若动画已启动，点击则停止                    loadingViewSimple1.stopAnimation();                }else {//若动画未启动，点击则开始                    loadingViewSimple1.startAnimation(800);                }            }        });    }}```>> **OK，简单自定义 View 的流程大概就是这么些了，若有遗漏或需要做出补充的，欢迎在评论区指出！大家一起探讨，一起进步！  努力！！！奋斗！！！**  ****博文地址：[这里](https://www.baidu.com) 